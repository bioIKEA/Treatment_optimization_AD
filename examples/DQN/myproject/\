from gym import Env
from gym.spaces import Discrete, Box
import numpy as np
import random


class AlzheimersEnv(Env):
    global total_visitor
    global episode_counter
    episode_counter=0
    global visitor_counter
    visitor_counter=0
    global total_episode
    def __init__(self):
        #extact data
        self.data=self.data()
        total_visitor=len(self.data)
        #a particular patient record of all the visits and patient's id
        patient_record=self.data[visitor_counter]
        #patient_id
        patient_id=list(patient_record[visitor_counter].keys())[0]
        total_episode=len(patient_record[patient_id])
        #particular visit record of that particular patient
        visit_record=first_patient_record[patient_id][0]
        #creating states
        self.normal_MMSE, self.normal_ADAS13, _ =first_visit_record

        #discrete actions: 2 main medication, no medication
        self.action_space=Discrete(3)
        # self.normal_ADAS13=5
        # self.normal_MMSE=30
        self.AD_ADAS13=85
        self.AD_MMSE=30
        #MMSE,ADAS13
        high = np.array(
                    [
                        normal_MMSE,
                        normal_ADAS13
                    ],
                    dtype=np.float32,
                )
        low = np.array(
                    [
                        AD_MMSE,
                        AD_ADAS13
                    ],
                    dtype=np.float32,
                )
        #observation of MMSE score of patients 
        self.observation_space=Box(low, high,dtype=np.float32,))

    def data(self):
        file = open('/Users/kritibbhattarai/Desktop/Combined.csv')
        csvreader = csv.reader(file, delimiter=',')
        reader=next(csvreader)
        # print(reader.index('CMMED'))
        lis=[]
        dic={}
        for row in csvreader:
            #RID
            id_1=float(row[0])
            #MMSE
            mmse=float(row[21])
            #ADAS13
            ADAS13=float(row[20])
            #action
            action=float(row[98])

            if id_1 in dic:
                dic[id_1].append((mmse,ADAS13,action))
            else:
                dic={}
                dic[id_1]=([(mmse,ADAS13,action)])
                lis.append(dic)
        return(lis)
        print(lis)
        print(len(lis))

    def step(self, action):
        episode_counter+=1
        self.original_MMSE=self.normal_MMSE

        self.n_patient_record=self.data[visitor_counter]
        #patient_id
        n_patient_id=list(n_patient_record[visitor_counter].keys())[0]
        #n record of that particular patient
        n_visit_record=n_patient_record[n_patient_id][episode_counter]
        #creating states
        self.normal_MMSE, self.normal_ADAS13, _ =first_visit_record
        self.state=(MMSE,ADAS13)
        
        reward=self.original_MMSE-self.normal_MMSE
        if episode_counter<=total_episodes:
            done=False
        else:
            done=True

        info={}
    return np.array(self.state, dtype=np.float32), reward, done, {}


    def render(self):
        pass
    def reset(self):
        self.co
        self.state=26
        return self.state
